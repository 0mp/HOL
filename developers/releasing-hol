# this shell script can be used to create a hol98 tar ball.

if [ $# -ne 2 ]
then
        echo "Usage: releasing-hol <releasename> <S/F user-id>"
        echo "  <releasename> can be "today" for testing purposes..."
        exit 1
fi
name=$1
userid=$2

mosmldir=/local/scratch/mn200/Work/mosml
cd /tmp

# use -r release-name for known release
if [ "$name" = "today" ]
then
  cvs -d:ext:${userid}@cvs.hol.sf.net:/cvsroot/hol export -D tomorrow hol98
else
  cvs -d:ext:${userid}@cvs.hol.sf.net:/cvsroot/hol export -r $name hol98
fi

sed "s|^val mosmldir.*\$|val mosmldir = \"$mosmldir\"|" \
   < hol98/tools/configure.sml | \
   sed 's|^val holdir.*$|val holdir = "/tmp/hol98"|' > new-config
mv hol98/tools/configure.sml /tmp
mv new-config hol98/tools/configure.sml

echo Removing all .cvsignore files
find hol98 -name .cvsignore -exec /bin/rm \{} \;

echo "Running configure script (original in /tmp)"
cd /tmp/hol98
$mosmldir/bin/mosml < tools/configure.sml

echo Now building Doc2Tex
cd help/src
../../bin/Holmake Doc2Tex

echo Now building documentation
for man_name in Reference Description Tutorial
do
    lcname=$(echo $man_name | tr A-Z a-z)
    echo Making $man_name
    cd /tmp/hol98/Manual/$man_name
    make all
    for i in .dvi .ps .pdf
    do
        mv $lcname$i /tmp/$name-$lcname$i
    done
done

echo Also removing Buddy documentation from distribution
cd /tmp/
mv hol98/src/muddy/muddyC/buddy/doc/*.ps .


echo Now starting to clean up and make tar ball
cd /tmp/hol98
/bin/rm -rf developers
/bin/rm -rf Manual
mv /tmp/configure.sml tools

mv bin/README ../bin-README
/bin/rm tools/Holmake/*.{uo,ui} tools/hol98-mode.el
/bin/rm tools/Holmake/{Parser,Lexer}.sml tools/Holmake/Parser.sig
/bin/rm tools/Holmake/Holmake_{parse.{sig,sml},tokens.sml}
(cd tools/quote-filter ; ../../bin/Holmake cleanAll)
(cd help/src ; ../../bin/Holmake cleanAll)
/bin/rm bin/*

mv ../bin-README bin/README


cd /tmp

echo "Creating tar file"
tar cvzf $name.tar.gz hol98

if [ "$name" != "today" ]
then
  mv hol98/doc/$name.release .
fi

