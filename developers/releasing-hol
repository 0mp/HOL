# this -*- shell-script -*- can be used to create a hol98 tar ball.

if [ $# -ne 3 ]
then
        echo "Usage: releasing-hol <releasename> <S/F user-id> <mosmldir>"
        echo "  <releasename> can be \"today\" for testing purposes..."
        exit 1
fi
name=$1
userid=$2
mosmldir=$3

if [ ! -x $mosmldir/bin/mosml ]
then
    echo "No mosml in $mosmldir/bin"
    exit 1
fi

cd /tmp

# use -r release-name for known release
echo "Getting copy of CVS repository from SourceForge"
echo -n "Progress: "
linecount=0
(if [ "$name" = "today" ]
then
  cvs -d:ext:${userid}@cvs.sf.net:/cvsroot/hol export -D tomorrow hol98
else
  cvs -d:ext:${userid}@cvs.sf.net:/cvsroot/hol export -r $name hol98
fi) 2>&1 | tee /tmp/cvs-export.log |
  while read foo
  do  linecount=$[ $linecount + 1 ]
      if [ $[ $linecount % 20 ] -eq 0 ] ; then echo -n . ; fi
  done

if [ $? -ne 0 ] ; then
  echo ; echo "CVS export failed, consult /tmp/cvs-export.log" ; exit 1
else
  echo
fi

echo Removing all .cvsignore files
find hol98 -name .cvsignore -exec /bin/rm \{} \;

echo "Running configure script"
cd /tmp/hol98
$mosmldir/bin/mosml < tools/smart-configure.sml > /tmp/config-log 2>&1
if [ $? -ne 0 ] ; then
  echo "HOL configuration failed, consult /tmp/config.log" ; exit 1
fi


echo Now building Doc2Tex
cd help/src
# ../../bin/Holmake Doc2Tex
../../bin/Holmake Doc2Tex.exe

echo Now building documentation
for man_name in Reference Description Tutorial
do
    lcname=$(echo $man_name | tr A-Z a-z)
    echo Making $man_name
    cd /tmp/hol98/Manual/$man_name
    if make all > /tmp/$man_name-latex.log 2>&1
    then :
    else echo Build failed ; exit 1
    fi
    for i in .dvi .ps .pdf
    do
        mv $lcname$i /tmp/$name-$lcname$i
    done
done

echo Also removing Buddy documentation from distribution
cd /tmp/
mv hol98/src/muddy/muddyC/buddy/doc/*.ps .

echo Building HolBddLib documentation
cd /tmp/hol98/src/HolBdd/Manual
if (latex HolBdd ; bibtex HolBdd ; latex HolBdd ; latex HolBdd ;
    dvips -G0 -Ppdf HolBdd ; ps2pdf HolBdd.ps) > /tmp/holbdd-latex.log 2>&1
then
   :
else
   echo Build failed
   exit 1
fi
for i in .dvi .ps .pdf
do
    mv HolBdd$i /tmp/$name-HolBdd$i
done

echo Building HolSatLib documentation
cd /tmp/hol98/src/HolSat/doc
if (latex HolSatLib ; latex HolSatLib ; dvips -G0 -Ppdf HolSatLib ;
    ps2pdf HolSatLib.ps) > /tmp/holsat-latex.log 2>&1
then
   :
else
   echo "Build failed, see /tmp/holsat-latex.log" ; exit 1
fi
for i in .dvi .ps .pdf
do
    mv HolSatLib$i /tmp/$name-HolSatLib$i
done

for lib_name in pred_set pair res_quan string taut unwind word
do
    echo Building $lib_name documentation
    cd /tmp/hol98/src/$lib_name/Manual
    if (make all) > /tmp/$lib_name-latex.log 2>&1
    then
       :
    else
       echo "Build failed, see /tmp/$lib_name-latex.log" ; exit 1
    fi
    for i in .dvi .ps .pdf
    do
        mv $lib_name$i /tmp/$name-$lib_name$i
    done
done

for lib_name in arith reduce
do
    echo Building num/$lib_name documentation
    cd /tmp/hol98/src/num/$lib_name/Manual
    if (make all) > /tmp/num-$lib_name-latex.log 2>&1
    then
       :
    else
       echo "Build failed, see /tmp/num-$lib_name-latex.log" ; exit 1
    fi
    for i in .dvi .ps .pdf
    do
        mv $lib_name$i /tmp/$name-$lib_name$i
    done
done

echo Now starting to clean up and make tar ball
cd /tmp/hol98
/bin/rm -rf developers
/bin/rm -rf Manual
/bin/rm -rf examples/sunrise
/bin/rm -rf src/HolBdd/Manual
/bin/rm -rf src/HolSat/doc

mv bin/README ../bin-README
/bin/rm tools/Holmake/*.{uo,ui} tools/hol98-mode.el
/bin/rm tools/Holmake/{Parser,Lexer}.sml tools/Holmake/Parser.sig
/bin/rm tools/Holmake/Holmake_{parse.{sig,sml},tokens.sml}
(cd tools/quote-filter ; ../../bin/Holmake cleanAll)
(cd help/src ; ../../bin/Holmake cleanAll)
/bin/rm bin/*

mv ../bin-README bin/README


cd /tmp
mv hol98 hol

echo "Creating tar file"
tar czf $name.tar.gz hol

if [ "$name" != "today" ]
then
  mv hol/doc/$name.release .
fi

